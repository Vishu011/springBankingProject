<div class="container">
  <div class="header">
    <h1>Apply for Card</h1>
    <p>Choose account, card type and brand. Limits and dates are set by admin during approval.</p>
  </div>

  <div *ngIf="loading" class="loading-message">Submitting...</div>
  <div *ngIf="errorMessage" class="message error-message">{{ errorMessage }}</div>
  <div *ngIf="successMessage" class="message success-message">{{ successMessage }}</div>

  <div class="form-container" *ngIf="!loading && accounts.length > 0">
    <form (ngSubmit)="onSubmit()" #applicationFormRef="ngForm" class="card-application-form">
      <!-- Account -->
      <div class="form-group">
        <label for="accountId">Account</label>
        <select
          id="accountId"
          name="accountId"
          [(ngModel)]="applicationForm.accountId"
          (change)="onAccountChange()"
          required>
          <option value="" disabled>Select Account</option>
          <option *ngFor="let account of accounts" [value]="account.accountId">
            {{ account.accountNumber }} - {{ account.accountType }} ({{ account.balance | currency:'INR':'symbol':'1.2-2' }})
          </option>
        </select>
      </div>

      <!-- Card Kind (CREDIT / DEBIT) -->
      <div class="form-group">
        <label>Card Type</label>
        <div class="type-options">
          <label class="radio">
            <input type="radio" name="cardKind" [value]="CardKind.CREDIT" [(ngModel)]="applicationForm.type" (change)="onTypeChange()" required>
            Credit
          </label>
          <label class="radio">
            <input type="radio" name="cardKind" [value]="CardKind.DEBIT" [(ngModel)]="applicationForm.type" (change)="onTypeChange()" required>
            Debit
          </label>
        </div>
      </div>

      <!-- Brand filtered by account type -->
      <div class="form-group">
        <label for="brand">Brand</label>
        <select
          id="brand"
          name="brand"
          [(ngModel)]="applicationForm.requestedBrand"
          required>
          <option *ngFor="let b of allowedBrands" [value]="b">{{ b }}</option>
        </select>
        <small class="help-text">
          Savings: VISA, RUPAY (CVV 3) â€¢ Salary/Corporate: AMEX, MASTERCARD, DISCOVERY (CVV 4).
      </small>
      </div>

      <!-- Issuance Fee -->
      <div class="form-group fee-group">
        <label>Issuance Fee</label>
        <div *ngIf="loadingFee" class="loading-message">Loading fee...</div>
        <div *ngIf="feeError" class="message error-message">{{ feeError }}</div>
        <div *ngIf="!loadingFee && !feeError">
          <span *ngIf="issuanceFeeAmount !== null">
            {{ issuanceFeeAmount | currency:(issuanceFeeCurrency || 'INR'):'symbol':'1.2-2' }}
            <span *ngIf="issuanceFeeDescription">- {{ issuanceFeeDescription }}</span>
          </span>
          <span *ngIf="issuanceFeeAmount === null">Fee not available.</span>
        </div>
        <small class="help-text">
          The issuance fee will be debited at approval or as per bank policy.
        </small>
      </div>

      <!-- OTP -->
      <div class="form-group">
        <label for="otpCode">OTP</label>
        <div class="otp-row">
          <input
            id="otpCode"
            name="otpCode"
            type="text"
            [(ngModel)]="applicationForm.otpCode"
            required
            maxlength="6"
            pattern="[0-9]{6}"
            placeholder="6-digit code">
          <button type="button" (click)="generateOtp()" class="generate-otp-button">Generate OTP</button>
        </div>
        <small class="help-text">A 6-digit OTP will be sent to your registered email.</small>
      </div>

      <!-- Submit -->
      <button type="submit" [disabled]="!applicationFormRef.valid || !applicationForm.accountId || !applicationForm.otpCode" class="submit-btn">
        Submit Application
      </button>
    </form>
  </div>

  <div *ngIf="!loading && accounts.length === 0" class="no-accounts-message">
    <p>You need an active account to apply for a card.</p>
    <a routerLink="/accounts" class="create-account-link">Go to Accounts</a>
  </div>
</div>
